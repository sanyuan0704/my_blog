(window.webpackJsonp=window.webpackJsonp||[]).push([[99],{169:function(t,e,_){"use strict";_.r(e);var s=_(0),i=Object(s.a)({},function(){var t=this,e=t.$createElement,_=t._self._c||e;return _("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),_("p",[_("img",{attrs:{src:t.$withBase("/tcp/002.jpg")}})]),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),_("p",[_("img",{attrs:{src:t.$withBase("/tcp/003.jpg")}})]),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),t._m(6),t._v(" "),t._m(7),t._v(" "),t._m(8),t._v(" "),t._m(9),t._v(" "),t._m(10),t._v(" "),_("p",[t._v("如果不等待会怎样？")]),t._v(" "),_("p",[t._v("如果不等待，客户端直接跑路，当服务端还有很多数据包要给客户端发，且还在路上的时候，若客户端的端口此时刚好被新的应用占用，那么就接收到了无用数据包，造成数据包混乱。所以，最保险的做法是等服务器发来的数据包都死翘翘再启动新的应用。")]),t._v(" "),_("p",[t._v("那，照这样说一个 MSL 不就不够了吗，为什么要等待 2 MSL?")]),t._v(" "),t._m(11),t._v(" "),_("p",[t._v("这就是等待 2MSL 的意义。")]),t._v(" "),t._m(12),t._v(" "),t._m(13),t._v(" "),_("p",[t._v("如果是三次挥手会有什么问题？")]),t._v(" "),t._m(14),t._v(" "),t._m(15),t._v(" "),_("p",[t._v("如果客户端和服务端同时发送 FIN ，状态会如何变化？如图所示:")]),t._v(" "),_("p",[_("img",{attrs:{src:t.$withBase("/tcp/014.jpg")}})])])},[function(){var t=this.$createElement,e=this._self._c||t;return e("h1",{attrs:{id:"_003-说说-tcp-四次挥手的过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_003-说说-tcp-四次挥手的过程","aria-hidden":"true"}},[this._v("#")]),this._v(" 003: 说说 TCP 四次挥手的过程")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"过程拆解"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#过程拆解","aria-hidden":"true"}},[this._v("#")]),this._v(" 过程拆解")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("刚开始双方处于"),e("code",[this._v("ESTABLISHED")]),this._v("状态。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("客户端要断开了，向服务器发送 "),e("code",[this._v("FIN")]),this._v(" 报文，在 TCP 报文中的位置如下图:")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("发送后客户端变成了"),e("code",[this._v("FIN-WAIT-1")]),this._v("状态。注意, 这时候客户端同时也变成了"),e("code",[this._v("half-close(半关闭)")]),this._v("状态，即无法向服务端发送报文，只能接收。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("服务端接收后向客户端确认，变成了"),e("code",[this._v("CLOSED-WAIT")]),this._v("状态。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("客户端接收到了服务端的确认，变成了"),e("code",[this._v("FIN-WAIT2")]),this._v("状态。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("随后，服务端向客户端发送"),e("code",[this._v("FIN")]),this._v("，自己进入"),e("code",[this._v("LAST-ACK")]),this._v("状态，")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("客户端收到服务端发来的"),e("code",[this._v("FIN")]),this._v("后，自己变成了"),e("code",[this._v("TIME-WAIT")]),this._v("状态，然后发送 ACK 给服务端。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("注意了，这个时候，客户端需要等待足够长的时间，具体来说，是 2 个 "),e("code",[this._v("MSL")]),this._v("("),e("code",[this._v("Maximum Segment Lifetime，报文最大生存时间")]),this._v("), 在这段时间内如果客户端没有收到服务端的重发请求，那么表示 ACK 成功到达，挥手结束，否则客户端重发 ACK。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"等待2msl的意义"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#等待2msl的意义","aria-hidden":"true"}},[this._v("#")]),this._v(" 等待2MSL的意义")])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[this._v("1 个 MSL 确保四次挥手中主动关闭方最后的 ACK 报文最终能达到对端")]),this._v(" "),e("li",[this._v("1 个 MSL 确保对端没有收到 ACK 重传的 FIN 报文可以到达")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"为什么是四次挥手而不是三次？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#为什么是四次挥手而不是三次？","aria-hidden":"true"}},[this._v("#")]),this._v(" 为什么是四次挥手而不是三次？")])},function(){var t=this,e=t.$createElement,_=t._self._c||e;return _("p",[t._v("因为服务端在接收到"),_("code",[t._v("FIN")]),t._v(", 往往不会立即返回"),_("code",[t._v("FIN")]),t._v(", 必须等到服务端所有的报文都发送完毕了，才能发"),_("code",[t._v("FIN")]),t._v("。因此先发一个"),_("code",[t._v("ACK")]),t._v("表示已经收到客户端的"),_("code",[t._v("FIN")]),t._v("，延迟一段时间才发"),_("code",[t._v("FIN")]),t._v("。这就造成了四次挥手。")])},function(){var t=this,e=t.$createElement,_=t._self._c||e;return _("p",[t._v("等于说服务端将"),_("code",[t._v("ACK")]),t._v("和"),_("code",[t._v("FIN")]),t._v("的发送合并为一次挥手，这个时候长时间的延迟可能会导致客户端误以为"),_("code",[t._v("FIN")]),t._v("没有到达客户端，从而让客户端不断的重发"),_("code",[t._v("FIN")]),t._v("。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"同时关闭会怎样？"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#同时关闭会怎样？","aria-hidden":"true"}},[this._v("#")]),this._v(" 同时关闭会怎样？")])}],!1,null,null,null);e.default=i.exports}}]);